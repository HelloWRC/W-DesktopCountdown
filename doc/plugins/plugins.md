# 插件指南

> 本应用提供了一些接口供开发者向本应用添加功能。您可以以插件的形式将您的功能添加到应用中。

## 文件结构

一个插件可以是一个文件夹，zip压缩包，或者是一个单独的Python文件。如果是文件夹或者是压缩包，那么必须以一个Python包的形式存在。下面是几种文件结构的示例：

```
single_file.py
folder/
⌊ __init__.py
⌊ functions.py
⌊ icon.png
zip_file.zip/
⌊ __init__.py
⌊ functions.py
⌊ icon.png
```

如果您的插件是以文件或压缩包的方式加载，您可以将图标命名为`icon.png`放置在插件根目录来自定义插件图标。如果是压缩文件，请注意检查是否所有的文件（`__init__.py`，…）都在压缩包根目录下。

## 插件元信息

这些信息需要在插件包的`__init__.py`或者是插件文件中定义。以下是所有可定义的信息。

| 名称                           | 类型                       | 是否必填 | 描述                                                         | 示例                   |
| ------------------------------ | -------------------------- | -------- | ------------------------------------------------------------ | ---------------------- |
| `plugin_id`                    | 字符串                     | 是       | 用来标识插件的唯一id                                         | `'wdcd.sample_plugin'` |
| `plugin_name`                  | 字符串                     | 是       | 插件名称                                                     | `'示例插件'`           |
| `plugin_author`                | 字符串                     | 否       | 插件作者                                                     | `'HelloWRC'`           |
| `plugin_website`               | 字符串                     | 否       | 插件网站                                                     | `'github.com'`         |
| `plugin_description`           | 字符串                     | 否       | 插件描述，支持Markdown语法。                                 | `'这是一个示例插件！'` |
| `plugin_default_config`        | 字典                       | 否       | 插件配置信息，可以通过这些信息生成配置界面。详细语法请参见[配置编写](#配置编写)。 | 略                     |
| `plugin_configure_ui`          | `QWidget`                  | 否       | 自定义配置界面。如果这一项被填写，那么将采用这里定义的插件配置界面。 | `ConfigureUI`          |
| `plugin_actions`               | 包括了`QAction` 对象的列表 | 否       | 填写自定义的动作。会在插件信息中显示，并可以被用户调用。     | `[action_sample]`      |
| `provided_effects`             | 包括了效果的列表           | 否       | 此列表包括了插件提供的效果。这些效果会在插件加载时被注册。   | `[SampleEffects]`      |
| `provided_actions`             | 包括了动作的列表           | 否       | 此列表包括了插件提供的动作。这些动作会在插件加载时被注册。   | `[SampleAction]`       |
| `provided_triggers`            | 包括了触发器的列表         | 否       | 此列表包括了插件提供的触发器。这些触发器会在加载时被注册。   | `[SampleTrigger]`      |
| `countdownmgr_toolbar_actions` | 包括了`QAction`对象的列表  | 否       | 此列表内的所有动作会添加到倒计时管理界面的工具栏上。         | `[action_sample]`      |
| `app_menu_actions`             | 包括了`QAction`对象的列表  | 否       | 此列表内的所有动作会添加到应用的托盘菜单上。                 | `[action_sample]`      |

## 配置编写

应用提供了一种不需要亲自设计配置界面就可以实现图形化配置的方式，需要定义`plugin_configure`来实现。`plugin_configure`是一个字典，键为配置名称，值是一个配置项字典。在插件加载时，会通过函数`on_load()`将配置信息通过参数传入。如果定义了`plugin_default_config`，那么传入的配置会根据每一项的默认值进行初始化。例如：

```python
{
    'string': {
        'type': 'string',
        'name': '这是一个字符串',
        'default': '默认值',
        'description': '在这里输入一个字符串。',  # 可选
        'placeholder': '占位符'  # 可选
    },
    'int': {
        'type': 'int',
        'name': '这是一个整数',
        'default': 0,
        'min': 0,
        'max': 10,
        # 可选选项
        'description': '在这里输入一个整数',
        'step': 1,
        'prefix': '',
        'suffix': ''
    }
}
```

应用会根据每一个配置项中的`default`项来初始化配置。那么被初始化后的配置是这样的：

```python
{
	'string': '默认值',
	'int': 0
}
```

同时应用会根据这个字典生成一个配置界面。配置界面的内容根据配置项的顺序自上向下渲染，并会在配置窗口关闭后自动保存配置。

以下是配置项的格式说明。

每个条目都有一个相同的项目`type`，用来指定配置项的类型。

配置项支持的类型有：

| `type`的值  | 类型                                |
| ----------- | ----------------------------------- |
| `string`    | [字符串](#字符串)                   |
| `int`       | [整数](#整数&浮点数)                |
| `float`     | [浮点数](#整数&浮点数)              |
| `bool`      | [布尔值](#布尔值)                   |
| `combo_box` | [下拉框](#下拉框)。可以从中选取元素 |
| `label`     | [在配置页面显示文本。](#标签)       |

配置项类型不同，会有不同的配置条目。点击表格中的链接可以快速导航到对应的类型。以下是每个类型的条目说明

### 字符串

| 条目          | 类型   | 是否必填 | 描述                                       | 示例                       |
| ------------- | ------ | -------- | ------------------------------------------ | -------------------------- |
| `type`        | 字符串 | 是       | 定义配置项类型                             | `'string'`                 |
| `name`        | 字符串 | 是       | 定义配置项显示名称                         | `'这是一个字符串'`         |
| `default`     | 字符串 | 是       | 配置项默认值                               | `'默认值'`                 |
| `description` | 字符串 | 否       | 配置描述，会在鼠标悬浮在对应的组件上时显示 | `'在这里填入一个字符串！'` |
| `placeholder` | 字符串 | 否       | 文本框占位符，会在文本框为空时以浅色显示   | `'占位符'`                 |

以下是这个配置项的一个示例：

```python
'string': {
	'type': 'string',
	'name': '这是一个字符串',
	'default': '默认值',
	'description': '在这里输入一个字符串。',  # 可选
	'placeholder': '占位符'  # 可选
}
```

### 整数&浮点数

| 条目          | 类型        | 是否必填 | 描述                                       | 示例                     |
| ------------- | ----------- | -------- | ------------------------------------------ | ------------------------ |
| `type`        | 字符串      | 是       | 定义配置项类型                             | `'int'`                  |
| `name`        | 字符串      | 是       | 定义配置项显示名称                         | `'这是一个整数'`         |
| `default`     | 整数/浮点数 | 是       | 配置项默认值                               | `0`                      |
| `min`         | 整数/浮点数 | 是       | 配置项的最小值                             | `0`                      |
| `max`         | 整数/浮点数 | 是       | 配置项的最大值                             | `10`                     |
| `description` | 字符串      | 否       | 配置描述，会在鼠标悬浮在对应的组件上时显示 | `'在这里填入一个整数！'` |
| `step`        | 整数/浮点数 | 否       | 输入框调整时每步的步数                     | `1`                      |
| `prefix`      | 字符串      | 否       | 输入框前缀                                 | `'前缀'`                 |
| `suffix`      | 字符串      | 否       | 输入框后缀                                 | `'米'`                   |

以下是这个配置项的一个示例：

```python
'int': {
	'type': 'int',
	'name': '这是一个整数',
	'default': 0,
	'min': 0,
	'max': 10,
	# 可选选项
	'description': '在这里输入一个整数',
	'step': 1,
	'prefix': '',
	'suffix': ''
},
```

### 布尔值

| 条目          | 类型   | 是否必填 | 描述                                       | 示例                       |
| ------------- | ------ | -------- | ------------------------------------------ | -------------------------- |
| `type`        | 字符串 | 是       | 定义配置项类型                             | `'bool'`                   |
| `name`        | 字符串 | 是       | 定义配置项显示名称                         | `'这是一个布尔值'`         |
| `default`     | 布尔值 | 是       | 配置项默认值                               | `False`                    |
| `description` | 字符串 | 否       | 配置描述，会在鼠标悬浮在对应的组件上时显示 | `'在这里选择一个布尔值！'` |

以下是这个配置项的一个示例：

```python
'bool': {
	'type': 'bool',
	'name': '这是一个布尔值',
	'default': False,
	# 可选选项
	'description': '在这里输入一个布尔值'
},
```

### 下拉框

>  **注意：下拉框类型的配置项返回的不是选择的项目内容而是选中项目的索引。**

| 条目          | 类型       | 是否必填 | 描述                                                         | 示例                          |
| ------------- | ---------- | -------- | ------------------------------------------------------------ | ----------------------------- |
| `type`        | 字符串     | 是       | 定义配置项类型                                               | `'combo_box'`                 |
| `name`        | 字符串     | 是       | 定义配置项显示名称                                           | `'这是一个下拉框'`            |
| `items`       | 字符串列表 | 是       | 下拉框中显示的项目                                           | `['item1', 'item2', 'item3']` |
| `default`     | 整数       | 是       | 配置项默认值。**注意：这里应该为下拉框项目的索引（从0开始）** | `0`                           |
| `description` | 字符串     | 否       | 配置描述，会在鼠标悬浮在对应的组件上时显示                   | `'在这里选择一个项目！'`      |

以下是这个配置项的一个示例：

```python
'combo_box': {
    'type': 'combo_box',
    'name': '这是一个下拉框',
    'items': [
        'item1', 'item2', 'item3'
    ],
    'default': 0,  # 索引值
    # 可选选项
    'description': '在这里选择一个颜色'
}
```

### 标签

| 条目         | 类型   | 是否必填 | 描述                           | 示例             |
| ------------ | ------ | -------- | ------------------------------ | ---------------- |
| `type`       | 字符串 | 是       | 定义配置项类型                 | `'label'`        |
| `text`       | 字符串 | 是       | 要显示的文本                   | `'这是一个标签'` |
| `word_warp`  | 布尔值 | 否       | 是否自动换行（默认为否）       | `False`          |
| `selectable` | 布尔值 | 否       | 文字是否可以被选中（默认为否） | `False`          |

这会在配置页面中插入一段文字。以下是这个配置项的一个实例：

```python
'label': {
    'type': 'label',
    'text': '这是一个标签',
    # 可选
    'word_warp': False,
    'selectable': True
}
```

## 插件方法

这些方法会在应用或者插件发生特定事件时被调用。

 

| 方法名                       | 是否必填 | 是否阻塞 | 传入参数                                                     | 描述                                 |
| ---------------------------- | -------- | -------- | ------------------------------------------------------------ | ------------------------------------ |
| `on_load`                    | 是       | 是       | `config`：字典，插件配置<br />`app`：`QApplication`对象      | 在插件被加载时调用                   |
| `on_appinit_p2`              | 否       | 否       | `app`：`QApplication`对象                                    | 在应用主循环开始后调用               |
| `on_app_quit`                | 否       | 否       | `app`：`QApplication`对象                                    | 在应用退出时调用                     |
| `on_app_exited`              | 否       | 是       | `app`：`QApplication`对象                                    | 在应用退出时调用，用于插件释放资源。 |
| `on_countdown_created`       | 否       | 是       | `app`：`QApplication`对象<br />`countdown`：`CountdownWin`对象 | 在倒计时被创建时调用                 |
| `on_countdown_removed`       | 否       | 是       | `app`：`QApplication`对象<br />`countdown`：`CountdownWin`对象 | 在倒计时被删除时调用                 |
| `on_countdown_state_changed` | 否       | 是       | `app`：`QApplication`对象<br />`countdown`：`CountdownWin`对象<br />`enabled`：布尔值，倒计时启用状态 | 在倒计时被禁用或者启用时被调用       |

## 函数修饰器

函数修饰器可以通过修饰特定的函数来达到某些效果。

### `@hook_QEvent(class, qevent)`

### `@hook_signal(class, signal)`

